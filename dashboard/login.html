<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | Money Medic SaaS</title>
    <link rel="stylesheet" href="login.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <div class="bg-glow"></div>

    <div class="login-container">
        <div class="logo-section">
            <span class="logo-icon">⚡</span>
            <h1 id="auth-title">Money Medic</h1>
            <p class="subtitle" id="auth-subtitle">AI 자동화 시스템으로 비즈니스를 가속하세요</p>
        </div>

        <div id="error-box" class="error-msg"></div>

        <div class="form-group">
            <label>Email Address</label>
            <input type="email" id="email" placeholder="name@company.com" required>
        </div>

        <div class="form-group">
            <label>Password</label>
            <input type="password" id="password" placeholder="••••••••" required>
        </div>

        <button id="auth-btn" class="btn-login">로그인</button>

        <div class="auth-switch">
            <span id="switch-text">계정이 없으신가요?</span>
            <a href="#" id="switch-link" class="auth-link">회원가입</a>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://kyicedypelnrnctkvicq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_GYfuzyBClnj4jHILADklcg_wsxlt2ZV';
        const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let isLoginMode = true;

        const emailEl = document.getElementById('email');
        const passwordEl = document.getElementById('password');
        const authBtn = document.getElementById('auth-btn');
        const errorBox = document.getElementById('error-box');
        const switchLink = document.getElementById('switch-link');
        const authTitle = document.getElementById('auth-title');
        const authSubtitle = document.getElementById('auth-subtitle');
        const switchText = document.getElementById('switch-text');

        // 모드 전환 (로그인 <-> 회원가입)
        switchLink.onclick = (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;
            authTitle.innerText = isLoginMode ? 'Money Medic' : 'Get Started';
            authSubtitle.innerText = isLoginMode ? 'AI 자동화 시스템으로 비즈니스를 가속하세요' : '새로운 계정을 생성하고 시스템을 구축하세요';
            authBtn.innerText = isLoginMode ? '로그인' : '회원가입';
            switchText.innerText = isLoginMode ? '계정이 없으신가요?' : '이미 계정이 있으신가요?';
            switchLink.innerText = isLoginMode ? '회원가입' : '로그인';
            errorBox.style.display = 'none';
        };

        // 인증 실행
        authBtn.onclick = async () => {
            const email = emailEl.value;
            const password = passwordEl.value;

            if (!email || !password) {
                showError('이메일과 비밀번호를 입력해주세요.');
                return;
            }

            authBtn.innerText = isLoginMode ? 'Logging in...' : 'Signing up...';
            authBtn.disabled = true;
            errorBox.style.display = 'none';

            let result;
            if (isLoginMode) {
                result = await db.auth.signInWithPassword({ email, password });
            } else {
                result = await db.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            nickname: email.split('@')[0]
                        }
                    }
                });
            }

            const { data, error } = result;
            console.log('Auth Result:', { data, error, isLoginMode });

            if (error) {
                console.error('Auth Error details:', error);
                showError(error.message + ' (상태: ' + error.status + ')');
                authBtn.innerText = isLoginMode ? '로그인' : '회원가입';
                authBtn.disabled = false;
            } else {
                // 이메일 인증이 꺼져있으면 바로 session이 생깁니다.
                if (data.session) {
                    console.log('Success! Session found. Redirecting to dashboard...');
                    window.location.href = 'index.html';
                } else if (!isLoginMode && data.user) {
                    console.warn('User created but no session. Email confirmation might still be ON.');
                    alert('가입 성공! 하지만 세션이 생성되지 않았습니다. 메일함을 확인하거나 Supabase에서 Confirm Email 설정을 다시 확인해주세요.');
                    isLoginMode = true;
                    switchLink.click();
                } else {
                    showError('알 수 없는 인증 상태입니다. 콘솔을 확인하세요.');
                }
            }
        };

        function showError(msg) {
            errorBox.innerText = msg;
            errorBox.style.display = 'block';
        }

        // 이미 로그인되어 있는지 확인
        async function checkSession() {
            const { data: { session } } = await db.auth.getSession();
            if (session) {
                window.location.href = 'index.html';
            }
        }
        checkSession();
    </script>
</body>

</html>